#!/usr/bin/env bash
set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ helper: show help â”€â”€â”€â”€â”€â”€â”€â”€â”€
_usage() {
  cat <<'EOF'
gh pr approve-and-auto-merge - approve & auto-merge dependency PRs

Usage:
  gh pr approve-and-auto-merge [options] <pr_numbers>
Examples:
  gh pr approve-and-auto-merge 123 124 125
  gh pr approve-and-auto-merge 123,124,125 --dry-run
  gh pr approve-and-auto-merge 42 --run --yes
Options:
  -h, --help        Show help
  -n, --dry-run     Preview only (default)
  -r, --run         Approve and merge (disables --dry-run)
  -y, --yes         Skip confirmation prompt
  --log-file <p>    Custom log file (default ~/.gh_auto_merge.log)
EOF
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ argument parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DRY_RUN=true
SKIP_CONFIRM=false
LOG_FILE="${HOME}/.gh_auto_merge.log"
PR_ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) _usage; exit 0 ;;
    -n|--dry-run) DRY_RUN=true ;;
    -r|--run|--force) DRY_RUN=false ;;
    -y|--yes) SKIP_CONFIRM=true ;;
    --log-file) shift; LOG_FILE=$1 ;;
    *) PR_ARGS+=("$1") ;;
  esac
  shift
done

if [[ ${#PR_ARGS[@]} -eq 0 ]]; then
  echo "âŒ  No PR numbers supplied."
  _usage
  exit 1
fi

# allow comma-separated lists, too
IFS=',' read -r -a PR_LIST <<<"${PR_ARGS[*]}"

# basic gh auth check
if ! command -v gh >/dev/null; then
  echo "âŒ  gh CLI not found"; exit 1
fi
if ! gh auth status >/dev/null 2>&1; then
  echo "âŒ  gh not authenticated (run gh auth login)"; exit 1
fi

echo "ğŸ”  Will process PRs: ${PR_LIST[*]}"
echo "    dry-run=${DRY_RUN}  log=${LOG_FILE}"
if ! $SKIP_CONFIRM; then
  read -p $'Proceed? [Y/n] ' CONFIRM
  CONFIRM=${CONFIRM:-Y}
elif ! $DRY_RUN; then
  read -p $'Proceed with approval and merge? [y/N] ' CONFIRM
  CONFIRM=${CONFIRM:-N}
  [[ ! $CONFIRM =~ ^[Yy]$ ]] && { echo "Aborted."; exit 1; }
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ core logic (simplified) â”€â”€â”€â”€
for pr in "${PR_LIST[@]}"; do
  echo "â€”â€”â€”  PR #$pr  â€”â€”â€”"
  title=$(gh pr view "$pr" --json title --jq '.title' 2>/dev/null || echo "")
  echo "ğŸ“  title: $title"

  # skip non-patch bumps
  if [[ "$title" =~ bump[[:space:]].*from[[:space:]][0-9]+\.[0-9]+\.[0-9]+[[:space:]]to[[:space:]][0-9]+\.[0-9]+\.[0-9]+ ]]; then
    :
  else
    echo "âš ï¸   Not a dependency bump â€“ skipping."
    continue
  fi

  # ensure CI green
  if ! gh pr checks "$pr" --required | grep -q "âœ”"; then
    echo "âš ï¸   CI not green â€“ skipping."
    continue
  fi

  if $DRY_RUN; then
    echo "ğŸ” (dry-run) Would approve & merge #$pr"
  else
    gh pr review "$pr" --approve --body "LGTM â€“ auto-approved by gh extension"
    gh pr merge  "$pr" --merge --auto --delete-branch --body "Auto-merged by gh extension"
    echo "âœ…  Merged #$pr" | tee -a "$LOG_FILE"
  fi
done
